{% extends "vps/view-hdr.html" %}
{% set subtitle='Dashboard' %}
{% block title %}{{ service.name }} - Servers{% endblock %}

{% block component %}

<div class="row-fluid pushdown">
	<div class="span6">
		<h4>Memory:</h4>
		<span class="specification">{{ service.memory }} mb</span>
	</div>

	<div class="span6">
		<h4>Swap:</h4>
		<span class="specification">{{ service.swap }} mb</span>
	</div>
</div>

<div class="row-fluid pushdown">
	<div class="span6">
		<h4>Disk:</h4>
		<span class="specification">{{ service.disk }} gb</span>
	</div>

	<div class="span6">
		<h4>Expiry:</h4>
		{% if service.expiry %}
		<span class="specification">{{ service.expiry | strftime('%m/%d/%Y') }} (${{ service.price | strf("{0:.2f}") }} per month)</span>
		{% else %}
		<span class="specification">Inactive</span>
		{% endif %}
	</div>
</div>

<div class="row-fluid pushdown">
	<div class="span6">
		<h4>IPv4:</h4>
		<span class="specification">{{ service.ips[0].ip if service.ips[0] }}</span>
	</div>

	<div class="span6">
		<h4>IPv6:</h4>
		<span class="specification">{{ service.ips[1].ip if service.ips[1] }}</span>
	</div>
</div>

<div class="row-fluid pushdown">
	<div class="span6">
		<h4>Host:</h4>
		<span class="specification">{{ service.node.name }}</span>
	</div>

	<div class="span6">
		<h4>Location:</h4>
		<span class="specification">{{ service.node.region.name }}</span>
	</div>
</div>

<div class="row-fluid">
	<div class="span6">
		<h4>CPU (8 cores):</h4>
		<div id="cpu-graph" class="span12 minigraph"></div>
	</div>

	<div class="span6">
		<h4>Network (20mbps guaranteed):</h4>
		<div id="net-graph" class="span12 minigraph"></div>
	</div>
</div>

<h4 class="service-hdr">Kernel Profiles</h4>

{% for prof in profiles %}
<div class="row-fluid">
	<div class="span9">
		{{ prof.name }}{% if prof.id == service.profile.id %} (selected){% endif %}
	</div>
	<div class="span3">
		<span class="pull-right">
			<form method="POST" action="{{ url_for('.create', vps=service.id) }}">
				<input type="hidden" name="profid" value="{{ prof.id }}">
				<button type="submit" class="btn btn-primary">Boot</button>
			</form>
		</span>
	</div>
</div>
{% endfor %}

<script type="text/javascript">
$(function() {
    var __tmf = "%H:%M";
    var __start = 3600;
    var __step = 60;
    var __baseuri = "";
    var __callback = null;

    function cpu_data_received(newdata, tmf) {
        var placeholder = $("#cpu-graph");
        var options = {
            lines: { show: true, fill: false },
    	    points: { show: false },
   	    grid: { show: true, borderColor: '#dddddd', borderWidth: 1 },
	    xaxis: { mode: "time", timeformat: tmf, timezone: "browser" },
            yaxis: { min: 0, label: "CPU usage (%)", tickFormatter: function(num, obj) { return num.toFixed(2) + "%"; } }
        }

        $.plot(placeholder, [newdata], options);
    }

    function net_data_received(newdata, tmf) {
        var placeholder = $("#net-graph");
        var options = {
            series: { stack: true },
            legend: { show: true },
            lines: { show: true, fill: false, stack: false },
    	    points: { show: false },
   	    grid: { show: true, borderColor: '#dddddd', borderWidth: 1 },
	    xaxis: { mode: "time", timeformat: tmf, timezone: "browser" },
            yaxis: { min: 0, label: "CPU usage (%)", tickFormatter: function(num, obj) {
                    if (num <= 1) { return num.toFixed(2); }
                    var suffix = ['', 'K', 'M', 'G'];
                    var i = parseInt(Math.floor(Math.log(num) / Math.log(1000)));
                    num /= Math.pow(1024, i);
                    return num.toFixed(2) + suffix[i];
                }
            }
        }

        $.plot(placeholder, newdata, options);
    }

    function get_uri(topic) {
        return '/vps/{{ service.id }}/' + topic + '/' + __start + '/' + __step;
    }

    $.ajax({
        url: get_uri('cpustats'),
        type: 'GET',
        dataType: 'json',
        success: function(d) { cpu_data_received(d, __tmf); }
    });

    $.ajax({
        url: get_uri('netstats'),
        type: 'GET',
        dataType: 'json',
        success: function(d) { net_data_received(d, __tmf); }
    });
});
</script>

{% endblock %}
